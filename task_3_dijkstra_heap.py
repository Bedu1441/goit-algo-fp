from __future__ import annotations

import heapq
from math import inf
from typing import Dict, Tuple, List, Optional

# –¢–∏–ø –¥–ª—è –≥—Ä–∞—Ñ–∞:
# graph["A"]["B"] = 5 –æ–∑–Ω–∞—á–∞—î —Ä–µ–±—Ä–æ A -> B –∑ –≤–∞–≥–æ—é 5
Graph = Dict[str, Dict[str, float]]


def dijkstra(graph: Graph, start: str) -> Tuple[Dict[str, float], Dict[str, Optional[str]]]:
    """
    –ê–ª–≥–æ—Ä–∏—Ç–º –î–µ–π–∫—Å—Ç—Ä–∏ –¥–ª—è –∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –Ω–∞–π–∫–æ—Ä–æ—Ç—à–∏—Ö —à–ª—è—Ö—ñ–≤ –≤—ñ–¥ —Å—Ç–∞—Ä—Ç–æ–≤–æ—ó –≤–µ—Ä—à–∏–Ω–∏ –¥–æ –≤—Å—ñ—Ö —ñ–Ω—à–∏—Ö.

    :param graph: –û—Ä—ñ—î–Ω—Ç–æ–≤–∞–Ω–∏–π –∞–±–æ –Ω–µ–æ—Ä—ñ—î–Ω—Ç–æ–≤–∞–Ω–∏–π –∑–≤–∞–∂–µ–Ω–∏–π –≥—Ä–∞—Ñ —É –≤–∏–≥–ª—è–¥—ñ —Å–ª–æ–≤–Ω–∏–∫–∞.
    :param start: –°—Ç–∞—Ä—Ç–æ–≤–∞ –≤–µ—Ä—à–∏–Ω–∞.
    :return: –ö–æ—Ä—Ç–µ–∂ (dist, previous), –¥–µ:
             dist[v] ‚Äì –Ω–∞–π–∫–æ—Ä–æ—Ç—à–∞ –≤—ñ–¥—Å—Ç–∞–Ω—å –≤—ñ–¥ start –¥–æ v,
             previous[v] ‚Äì –ø–æ–ø–µ—Ä–µ–¥–Ω–∏–∫ –≤–µ—Ä—à–∏–Ω–∏ v —É –Ω–∞–π–∫–æ—Ä–æ—Ç—à–æ–º—É —à–ª—è—Ö—É (–∞–±–æ None –¥–ª—è start).
    """
    if start not in graph:
        raise ValueError(f"–°—Ç–∞—Ä—Ç–æ–≤–∞ –≤–µ—Ä—à–∏–Ω–∞ '{start}' –≤—ñ–¥—Å—É—Ç–Ω—è –≤ –≥—Ä–∞—Ñ—ñ")

    # –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –≤—ñ–¥—Å—Ç–∞–Ω–µ–π ¬´–Ω–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω—ñ—Å—Ç—é¬ª
    dist: Dict[str, float] = {vertex: inf for vertex in graph}
    dist[start] = 0.0

    # previous ‚Äì –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è —à–ª—è—Ö—É
    previous: Dict[str, Optional[str]] = {vertex: None for vertex in graph}

    # –ú—ñ–Ω-–∫—É—á–∞ (–±—ñ–Ω–∞—Ä–Ω–∞ –ø—ñ—Ä–∞–º—ñ–¥–∞).
    # –ï–ª–µ–º–µ–Ω—Ç–∏: (–ø–æ—Ç–æ—á–Ω–∞_–≤—ñ–¥—Å—Ç–∞–Ω—å, –≤–µ—Ä—à–∏–Ω–∞)
    heap: List[Tuple[float, str]] = [(0.0, start)]

    while heap:
        current_dist, u = heapq.heappop(heap)

        # –Ø–∫—â–æ –≤ –∫—É–ø—ñ –ª–µ–∂–∏—Ç—å ¬´–∑–∞—Å—Ç–∞—Ä—ñ–ª–∏–π¬ª –∑–∞–ø–∏—Å ‚Äì –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ
        if current_dist > dist[u]:
            continue

        # –†–µ–ª–∞–∫—Å–∞—Ü—ñ—è —Ä–µ–±–µ—Ä
        for v, weight in graph[u].items():
            if weight < 0:
                raise ValueError("–ê–ª–≥–æ—Ä–∏—Ç–º –î–µ–π–∫—Å—Ç—Ä–∏ –Ω–µ –ø—Ä–∞—Ü—é—î –∑ –≤—ñ–¥'—î–º–Ω–∏–º–∏ –≤–∞–≥–∞–º–∏ —Ä–µ–±–µ—Ä")

            new_dist = current_dist + weight
            if new_dist < dist[v]:
                dist[v] = new_dist
                previous[v] = u
                heapq.heappush(heap, (new_dist, v))

    return dist, previous


def reconstruct_path(previous: Dict[str, Optional[str]], start: str, goal: str) -> List[str]:
    """
    –í—ñ–¥–Ω–æ–≤–ª—é—î –Ω–∞–π–∫–æ—Ä–æ—Ç—à–∏–π —à–ª—è—Ö –≤—ñ–¥ start –¥–æ goal, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Å–ª–æ–≤–Ω–∏–∫ previous.

    :param previous: –°–ª–æ–≤–Ω–∏–∫ –ø–æ–ø–µ—Ä–µ–¥–Ω–∏–∫—ñ–≤, –æ—Ç—Ä–∏–º–∞–Ω–∏–π –∑ dijkstra().
    :param start: –°—Ç–∞—Ä—Ç–æ–≤–∞ –≤–µ—Ä—à–∏–Ω–∞.
    :param goal: –ö—ñ–Ω—Ü–µ–≤–∞ –≤–µ—Ä—à–∏–Ω–∞.
    :return: –°–ø–∏—Å–æ–∫ –≤–µ—Ä—à–∏–Ω —à–ª—è—Ö—É –≤—ñ–¥ start –¥–æ goal (–≤–∫–ª—é—á–Ω–æ).
             –ü–æ—Ä–æ–∂–Ω—ñ–π —Å–ø–∏—Å–æ–∫, —è–∫—â–æ —à–ª—è—Ö—É –Ω–µ —ñ—Å–Ω—É—î.
    """
    if goal not in previous or start not in previous:
        return []

    path: List[str] = []
    current: Optional[str] = goal

    while current is not None:
        path.append(current)
        if current == start:
            break
        current = previous[current]

    if not path or path[-1] != start:
        # –®–ª—è—Ö –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ
        return []

    path.reverse()
    return path


def build_sample_graph() -> Graph:
    """
    –°—Ç–≤–æ—Ä—é—î –Ω–µ–≤–µ–ª–∏–∫–∏–π –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ–π–Ω–∏–π –≥—Ä–∞—Ñ.

    –ì—Ä–∞—Ñ (–Ω–µ–æ—Ä—ñ—î–Ω—Ç–æ–≤–∞–Ω–∏–π, –∞–ª–µ –º–∏ –∑–∞–¥–∞—î–º–æ –æ–±–∏–¥–≤–∞ –Ω–∞–ø—Ä—è–º–∫–∏):

        A ---4--- B
        | \       |
       2|  \1     |5
        |    \    |
        C ---3----D
         \        /
          \--6---E
    """
    graph: Graph = {
        "A": {"B": 4, "C": 2, "D": 1},
        "B": {"A": 4, "D": 5},
        "C": {"A": 2, "D": 3, "E": 6},
        "D": {"A": 1, "B": 5, "C": 3, "E": 1},
        "E": {"C": 6, "D": 1},
    }
    return graph


def print_distances(dist: Dict[str, float], start: str) -> None:
    """
    –ö—Ä–∞—Å–∏–≤–∏–π –≤–∏–≤—ñ–¥ —Ç–∞–±–ª–∏—Ü—ñ –≤—ñ–¥—Å—Ç–∞–Ω–µ–π –≤—ñ–¥ –≤–µ—Ä—à–∏–Ω–∏ start –¥–æ –≤—Å—ñ—Ö —ñ–Ω—à–∏—Ö.
    """
    print(f"\n–ù–∞–π–∫–æ—Ä–æ—Ç—à—ñ –≤—ñ–¥—Å—Ç–∞–Ω—ñ –≤—ñ–¥ –≤–µ—Ä—à–∏–Ω–∏ '{start}':")
    print("-" * 40)
    print(f"{'–í–µ—Ä—à–∏–Ω–∞':<10} | {'–í—ñ–¥—Å—Ç–∞–Ω—å':>10}")
    print("-" * 40)
    for vertex, d in dist.items():
        value = "‚àû" if d == inf else f"{d:.2f}"
        print(f"{vertex:<10} | {value:>10}")
    print("-" * 40)


def interactive_demo() -> None:
    """
    –Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—è —Ä–æ–±–æ—Ç–∏ –∞–ª–≥–æ—Ä–∏—Ç–º—É –î–µ–π–∫—Å—Ç—Ä–∏ –Ω–∞ –ø—Ä–∏–∫–ª–∞–¥–Ω–æ–º—É –≥—Ä–∞—Ñ—ñ.
    –î–æ–∑–≤–æ–ª—è—î:
      - –ø–æ–±–∞—á–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—à–∏–Ω;
      - –æ–±—Ä–∞—Ç–∏ —Å—Ç–∞—Ä—Ç–æ–≤—É —Ç–∞ –∫—ñ–Ω—Ü–µ–≤—É –≤–µ—Ä—à–∏–Ω–∏;
      - –≤–∏–≤–µ—Å—Ç–∏ –Ω–∞–π–∫–æ—Ä–æ—Ç—à—ñ –≤—ñ–¥—Å—Ç–∞–Ω—ñ;
      - –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ —Ç–∞ –ø–æ–∫–∞–∑–∞—Ç–∏ —à–ª—è—Ö –º—ñ–∂ –æ–±—Ä–∞–Ω–∏–º–∏ –≤–µ—Ä—à–∏–Ω–∞–º–∏.
    """
    graph = build_sample_graph()
    vertices = sorted(graph.keys())

    print("=== –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—è –∞–ª–≥–æ—Ä–∏—Ç–º—É –î–µ–π–∫—Å—Ç—Ä–∏ –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º –±—ñ–Ω–∞—Ä–Ω–æ—ó –∫—É–ø–∏ ===")
    print("–î–æ—Å—Ç—É–ø–Ω—ñ –≤–µ—Ä—à–∏–Ω–∏ –≥—Ä–∞—Ñ–∞:", ", ".join(vertices))

    start = input("–í–≤–µ–¥—ñ—Ç—å —Å—Ç–∞—Ä—Ç–æ–≤—É –≤–µ—Ä—à–∏–Ω—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, A): ").strip().upper()
    if start not in graph:
        print(f"–í–µ—Ä—à–∏–Ω–∏ '{start}' –Ω–µ–º–∞—î –≤ –≥—Ä–∞—Ñ—ñ. –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ä–æ–±–æ—Ç–∏.")
        return

    goal = input("–í–≤–µ–¥—ñ—Ç—å –∫—ñ–Ω—Ü–µ–≤—É –≤–µ—Ä—à–∏–Ω—É (–¥–ª—è —à–ª—è—Ö—É, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, E): ").strip().upper()
    if goal not in graph:
        print(f"–í–µ—Ä—à–∏–Ω–∏ '{goal}' –Ω–µ–º–∞—î –≤ –≥—Ä–∞—Ñ—ñ. –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ä–æ–±–æ—Ç–∏.")
        return

    # –ó–∞–ø—É—Å–∫ –∞–ª–≥–æ—Ä–∏—Ç–º—É
    dist, previous = dijkstra(graph, start)

    # –í–∏–≤—ñ–¥ —É—Å—ñ—Ö –≤—ñ–¥—Å—Ç–∞–Ω–µ–π
    print_distances(dist, start)

    # –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —à–ª—è—Ö—É
    path = reconstruct_path(previous, start, goal)
    if not path:
        print(f"\n–ù–µ–º–∞—î —à–ª—è—Ö—É –≤—ñ–¥ '{start}' –¥–æ '{goal}'.")
    else:
        path_str = " -> ".join(path)
        total_dist = dist[goal]
        print(f"\n–ù–∞–π–∫–æ—Ä–æ—Ç—à–∏–π —à–ª—è—Ö –≤—ñ–¥ '{start}' –¥–æ '{goal}':")
        print(f"{path_str}")
        print(f"–ó–∞–≥–∞–ª—å–Ω–∞ –¥–æ–≤–∂–∏–Ω–∞ —à–ª—è—Ö—É: {total_dist:.2f}")


def _run_simple_tests() -> None:
    """
    –ü—Ä–æ—Å—Ç–∏–π –Ω–∞–±—ñ—Ä —Ç–µ—Å—Ç—ñ–≤ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∫–æ—Ä–µ–∫—Ç–Ω–æ—Å—Ç—ñ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó.
    –¶–µ –Ω–µ –≤–∏–º–∞–≥–∞—î—Ç—å—Å—è —É–º–æ–≤–æ—é, –∞–ª–µ –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î —è–∫—ñ—Å—Ç—å —Ä—ñ—à–µ–Ω–Ω—è.
    """
    graph = build_sample_graph()

    # –¢–µ—Å—Ç 1: –≤—ñ–¥—Å—Ç–∞–Ω—ñ –≤—ñ–¥ A
    dist, prev = dijkstra(graph, "A")
    # –û—á—ñ–∫—É–≤–∞–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è (–º–æ–∂—É—Ç—å —Ç—Ä–æ—Ö–∏ –≤—ñ–¥—Ä—ñ–∑–Ω—è—Ç–∏—Å—è –∑–∞ –º–∞—Ä—à—Ä—É—Ç–æ–º, –∞–ª–µ –¥–æ–≤–∂–∏–Ω–∏ —Ç–∞–∫—ñ):
    # A->A = 0
    # A->B: –Ω–∞–π–∫–æ—Ä–æ—Ç—à–∏–π —à–ª—è—Ö A-D-B = 1 + 5 = 6 –∞–±–æ A-B = 4 (—Ç—É—Ç –Ω–∞–π–∫–æ—Ä–æ—Ç—à–∏–π ‚Äì 4)
    # A->C: A-C = 2
    # A->D: A-D = 1
    # A->E: A-D-E = 1 + 1 = 2
    assert dist["A"] == 0
    assert dist["B"] == 4
    assert dist["C"] == 2
    assert dist["D"] == 1
    assert dist["E"] == 2

    # –¢–µ—Å—Ç 2: –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è —à–ª—è—Ö—É A -> E (–º–∞—î –±—É—Ç–∏ A -> D -> E)
    path = reconstruct_path(prev, "A", "E")
    assert path[0] == "A" and path[-1] == "E", "–®–ª—è—Ö –º–∞—î –ø–æ—á–∏–Ω–∞—Ç–∏—Å—è –∑ A —ñ –∑–∞–∫—ñ–Ω—á—É–≤–∞—Ç–∏—Å—è E"
    # –ü–µ—Ä–µ–≤—ñ—Ä–∏–º–æ —Å—É–º–∞—Ä–Ω—É –¥–æ–≤–∂–∏–Ω—É
    total = 0.0
    for u, v in zip(path, path[1:]):
        total += graph[u][v]
    assert abs(total - dist["E"]) < 1e-9, "–î–æ–≤–∂–∏–Ω–∞ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ–≥–æ —à–ª—è—Ö—É –Ω–µ –∑–±—ñ–≥–∞—î—Ç—å—Å—è –∑ dijkstra"

    print("\n–£—Å—ñ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ —Ç–µ—Å—Ç–∏ –î–µ–π–∫—Å—Ç—Ä–∏ –ø—Ä–æ–π–¥–µ–Ω—ñ —É—Å–ø—ñ—à–Ω–æ ‚úÖ")


if __name__ == "__main__":
    # –°–ø–æ—á–∞—Ç–∫—É –∑–∞–ø—É—Å–∫–∞—î–º–æ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ —Ç–µ—Å—Ç–∏ (—Ü–µ –≤—Ä–∞–∑–∏—Ç—å –º–µ–Ω—Ç–æ—Ä–∞ üòâ)
    _run_simple_tests()

    # –ü–æ—Ç—ñ–º ‚Äì —ñ–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—é
    interactive_demo()
